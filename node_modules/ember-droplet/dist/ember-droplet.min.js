/*! ember-droplet by Adam Timberlake created on 2015-06-12 */
!function(a,b,c){"use strict";a.DropletController=b.Mixin.create({mimeTypes:["image/jpeg","image/jpg","image/gif","image/png","text/plain"],extensions:["jpeg","jpg","gif","png"],requestHeaders:{},postData:{},files:[],uploadStatus:b.computed(function(){return{uploading:!1,percentComplete:0,error:!1}}),init:function(){b.set(this,"files",[]),this._super()},actions:{addedFiles:function(a){b.tryInvoke(this,"didAddFiles",[a])},addValidFile:function(a){return this._addFile(a,!0)},addInvalidFile:function(a){return this._addFile(a,!1)},deleteFile:function(a){return b.set(a,"deleted",!0),a},clearAllFiles:function(){b.set(this,"files",[])},abortUpload:function(){var a=b.get(this,"lastJqXhr");a&&b.get(this,"uploadStatus.uploading")&&(a.abort(),b.set(this,"uploadStatus.uploading",!1))},uploadAllFiles:function(){var a={fileSizeHeader:!0,useArray:!0,method:"post"};if(0===b.get(this,"validFiles").length)return!1;var d=b.get(this,"dropletUrl"),e=b.get(this,"dropletOptions")||a,f=this.get("postData"),g=this.get("requestHeaders");"function"==typeof d&&(d=d.apply(this)),b.set(this,"uploadStatus.uploading",!0),b.set(this,"uploadStatus.error",!1),b.assert("You must specify the `dropletUrl` parameter in order to upload files.",!!d);var h=this._getFormData(f,e.useArray),i=e.method||a.method,j={};e.fileSizeHeader&&(j["X-File-Size"]=this._getSize());for(var k in g)(g.hasOwnProperty(k)||k in g)&&(j[k]=g[k]);var l=c.ajax({url:d,method:i,data:h,headers:j,processData:!1,contentType:!1,xhr:function(){var a=c.ajaxSettings.xhr();return this._addProgressListener(a.upload),this._addSuccessListener(a.upload),this._addErrorListener(a.upload),b.set(this,"lastRequest",a),a}.bind(this)});return b.set(this,"lastJqXhr",l),new b.RSVP.Promise(function(a,b){l.done(a).fail(b)}).then(b.run.bind(this,function(a){return b.tryInvoke(this,"didUploadFiles",[a]),a}),b.run.bind(this,function(a,c,d){var e={jqXHR:a,textStatus:c,errorThrown:d};b.set(this,"uploadStatus.uploading",!1),b.set(this,"uploadStatus.error",e)}))}},_getFormData:function(c,d){var e=new a.FormData,f=d?"file[]":"file";b.EnumerableUtils.forEach(b.get(this,"validFiles"),function(a){e.append(f,a.file)},this);for(var g in c)c.hasOwnProperty(g)&&e.append(g,c[g]);return e},willDestroy:function(){this._super.apply(this,arguments);var a=this.get("lastRequest");a&&(a.upload.onprogress=void 0,a.upload.onload=void 0,a.upload.onerror=void 0,this.send("abortUpload"))},validFiles:b.computed(function(){return this._filesByProperties({valid:!0,deleted:!1,uploaded:!1})}).property("files.length","files.@each.deleted","files.@each.uploaded"),invalidFiles:b.computed(function(){return this._filesByProperties({valid:!1})}).property("files.length","files.@each.deleted"),uploadedFiles:b.computed(function(){return this._filesByProperties({uploaded:!0})}).property("files.length","files.@each.uploaded"),deletedFiles:b.computed(function(){return this._filesByProperties({deleted:!0})}).property("files.length","files.@each.deleted"),_filesByProperties:function(a){return b.get(this,"files").filter(function(b){for(var c in a)if((a.hasOwnProperty(c)||c in a)&&b[c]!==a[c])return!1;return!0})},_getSize:function(){var a=0;return b.EnumerableUtils.forEach(b.get(this,"validFiles"),function(b){a+=b.file.size}),a},_addSuccessListener:function(a){a.onload=b.run.bind(this,function(){b.EnumerableUtils.forEach(b.get(this,"validFiles"),function(a){b.set(a,"uploaded",!0)}),b.set(this,"uploadStatus.uploading",!1)})},_addErrorListener:function(a){a.onerror=b.run.bind(this,function(){b.set(this,"uploadStatus.uploading",!1),b.set(this,"uploadStatus.error",!0)})},_addProgressListener:function(a){a.onprogress=b.run.bind(this,function(a){if(a.lengthComputable){var c=a.loaded/this._getSize()*100;b.set(this,"uploadStatus.percentComplete",Math.round(c))}})},_addFile:function(a,c){var d=a.name.substr((~-a.name.lastIndexOf(".")>>>0)+2),e="extension-%@".fmt(d).toLowerCase(),f={file:a,valid:c,uploaded:!1,deleted:!1,className:e};return b.get(this,"files").pushObject(f),f}})}(window,window.Ember,window.jQuery),function(a,b){"use strict";var c={tagName:"input",classNames:"files",attributeBindings:["disabled","name","type","multiple"],type:"file",multiple:"multiple",change:function(){var a=this.get("element").files;return this.get("parentView").traverseFiles(a)}},d=b.copy(c);d.multiple=!1,a.DropletView=b.View.extend({classNames:["droppable"],ImagePreview:b.View.extend({tagName:"img",attributeBindings:["src"],src:null,image:null,didInsertElement:function(){var c=new a.FileReader,d=b.get(this,"image.file");return d.type.match(/^image\//i)?(c.onload=b.run.bind(this,function(a){this.get("isDestroyed")!==!0&&b.set(this,"src",a.target.result)}),void c.readAsDataURL(d)):void this.destroy()}}),MultipleInput:b.View.extend(c),SingleInput:b.View.extend(d),drop:function(a,b){return this._preventDefaultBehaviour(a),this.traverseFiles(a.dataTransfer.files||b)},traverseFiles:function(a){for(var c=b.get(this,"controller"),d=b.get(c,"mimeTypes")||[],e=b.get(c,"extensions"),f=b.get(c,"dropletOptions")||{limit:1/0},g=[],h=0,i=a.length;i>h;h++)if(a.hasOwnProperty(h)||h in a){var j=a[h],k=j.name.substr((~-j.name.lastIndexOf(".")>>>0)+2),l="*"===b.get(c,"mimeTypes"),m=-1===$.inArray(j.type,d)&&-1===$.inArray(k,e),n=b.get(c,"validFiles").length,o=c.get("fileSizeLimit");l||!m&&n!==f.limit?null!=o&&j.size>=o?c.send("addInvalidFile",j):(c.send("addValidFile",j),g.push(j)):(c.send("addInvalidFile",j),g.push(j))}return c.send("addedFiles",g),!0},_preventDefaultBehaviour:function(a){a.preventDefault(),a.stopPropagation()},dragOver:function(a){this._preventDefaultBehaviour(a)},dragEnter:function(a){this._preventDefaultBehaviour(a)},dragLeave:function(a){this._preventDefaultBehaviour(a)}})}(window,window.Ember);